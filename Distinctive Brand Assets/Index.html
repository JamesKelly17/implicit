<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>Brand Association Study</title>
    <style>
        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        /* ===== INSTRUCTION SCREENS ===== */
        .instructions {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.6;
        }

        .instructions h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .instructions ul {
            margin: 20px 0;
            padding-left: 30px;
        }

        .instructions li {
            margin: 10px 0;
        }

        .button {
            background: #1DB954;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
        }

        .button:hover {
            background: #1ed760;
        }

        /* ===== TASK CONTAINER (Main experimental area) ===== */
        .task-container {
            display: none;
            position: relative;
            width: 100%;
            max-width: 700px;
            height: 500px;
            border: 3px solid black;
            background: white;
            margin: 0 auto;
        }

        .task-container.mobile {
            max-width: 90vw;
            height: 90vh;
        }

        /* ===== BRAND LABELS (Top corners) ===== */
        .label-left, .label-right {
            position: absolute;
            top: 1%;
            font-size: 30px;
            font-weight: bold;
            text-align: center;
            font-family: arial;
        }

        .label-left { left: 4%; }
        .label-right { right: 4%; }

        /* Key instruction labels (e.g., "press e") */
        .label-left2, .label-right2 {
            position: absolute;
            top: 8%;
            font-size: 20px;
            text-align: center;
            font-family: arial;
        }

        .label-left2 { left: 4%; }
        .label-right2 { right: 4%; }

        /* ===== CENTER DISPLAY AREA (Fixation cross, images, logos) ===== */
        .message-center {
            position: absolute;
            text-align: center;
            width: 100%;
            top: 50%;
            left: 0;
            transform: translateY(-90px);
            font-size: 30px;
            font-weight: bold;
            font-family: arial;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 180px;
            line-height: 1;
        }

        /* Error message (red X below stimulus) */
        .error-message {
            position: absolute;
            text-align: center;
            width: 100%;
            bottom: 8%;
            font-size: 80px;
            font-weight: bold;
            color: red;
        }

        /* Loading message */
        .loading-message {
            position: absolute;
            top: 55%;
            width: 100%;
            text-align: center;
            font-size: 16px;
            font-family: "Times New Roman";
        }

        /* Round instructions (displayed at start of each round) */
        .task-instructions {
            position: absolute;
            text-align: center;
            bottom: 0%;
            font-size: 16px;
            font-family: "Times New Roman";
            display: none;
            padding: 10px;
            line-height: 110%;
        }

        /* ===== MOBILE TOUCH BUTTONS ===== */
        .mobile-buttons {
            display: none;
        }

        .mobile-buttons.show {
            display: block;
        }

        .mobile-button {
            position: absolute;
            bottom: 2%;
            background: #1DB954;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
        }

        .mobile-button.left { left: 2%; }
        .mobile-button.right { right: 2%; }

        /* ===== COMPLETION SCREEN ===== */
        .completion {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .completion h2 {
            color: #1DB954;
            margin-bottom: 20px;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        /* ===== STIMULUS STYLES ===== */
        /* Stimulus images (colored squares) */
        .stimulus-image {
            width: 180px;
            height: 180px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        
        /* Brand text stimuli */
        .stimulus-text {
            width: 180px;
            height: 180px;
            font-size: 28px;
            font-weight: bold;
            color: black;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            margin: 0 auto;
            border: 3px solid #333;
            padding: 10px;
            box-sizing: border-box;
        }

        /* ===== MOBILE RESPONSIVE STYLES ===== */
        @media (max-width: 768px) {
            /* Smaller brand labels on mobile */
            .label-left, .label-right {
                font-size: 20px;
                line-height: 100%;
            }
            
            .label-left2, .label-right2 {
                font-size: 14px;
                top: 6%;
            }

            /* Adjust center display for mobile screen */
            .message-center {
                height: 150px;
                font-size: 28px;
                transform: translateY(-75px);
            }

            /* Smaller stimuli on mobile */
            .stimulus-image {
                width: 150px;
                height: 150px;
            }
            
            .stimulus-text {
                width: 150px;
                height: 150px;
                font-size: 22px;
                padding: 8px;
            }

            /* Position instructions higher to avoid button overlap */
            .task-instructions {
                bottom: 25%;
                font-size: 14px;
                max-height: 65%;
                overflow-y: auto;
            }

            /* Larger, taller mobile buttons for easy tapping */
            .mobile-button {
                padding: 50px 25px;
                font-size: 22px;
                font-weight: bold;
                min-height: 120px;
                width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ===== INITIAL INSTRUCTIONS SCREEN ===== -->
        <div class="instructions" id="initialInstructions">
            <h1><strong style="color:rgb(43, 154, 130)">Priming Based Implicit</strong></h1>
            <h3>Distinctive Brand Assets</h3>
            <p>Today you will be playing a matching game.</p>
            <p>During the game, brand names will appear in the middle of your screen.</p>
            <br>
            <p id="keyInstructions">
                When the brand name matches the top left brand, press the <strong>E</strong> key as fast as you can. 
                When it matches the top right brand, press the <strong>I</strong> key as fast as you can.
            </p>
            <p id="buttonInstructions" class="hidden">
                When the brand name matches the top left brand, press the <strong>Left</strong> button as fast as you can. 
                When it matches the top right brand, press the <strong>Right</strong> button as fast as you can.
            </p>
            <p>If you make an error, a red <strong style="color:red">X</strong> will appear. Correct errors by hitting the other key/button.</p>
            <br>
            <p>Please try to go <strong><em>as fast as you can</em></strong> while making as few errors as possible. 
            If you are going too slow, a <span style="color: red">"Too Slow"</span> message will appear.</p>
            <button class="button" onclick="showRoundInstructions()">Continue</button>
        </div>

        <!-- ===== ROUND STRUCTURE INSTRUCTIONS ===== -->
        <div class="instructions hidden" id="roundInstructions">
            <h2>Game Structure</h2>
            <p>There will be 3 rounds to the game.</p>
            <ul>
                <li><strong>Round 1:</strong> will be a training round to practice</li>
                <li><strong>Round 2:</strong> will be the official start of the game. Your scores will count in this round!</li>
                <li><strong>Round 3:</strong> will be the same as before. But this time, random images will briefly appear before the brand names. 
                Remember, <span style="color:#c0392b;"><strong>your task will stay the same</strong>.</span> Keep matching the brand names like you did before!</li>
            </ul>
            <p><strong>Good luck!</strong> Remember to go as quickly as you can.</p>
            <p>Click the button to start the game</p>
            <button class="button" onclick="startTask()">Start Game</button>
        </div>

        <!-- ===== TASK CONTAINER (Main experimental area) ===== -->
        <div class="task-container" id="taskContainer">
            <!-- Brand labels (randomized position) -->
            <div class="label-left">Apple Music</div>
            <div class="label-left2">(press "e")</div>
            <div class="label-right">Spotify</div>
            <div class="label-right2">(press "i")</div>
            
            <!-- Center display area for stimuli -->
            <div class="message-center" id="messageCenter">+</div>
            <div class="error-message" id="errorMessage"></div>
            
            <!-- Loading message -->
            <div class="loading-message" id="loadingMessage">
                Loading all the content...<br><br>This should take less than 1 minute
            </div>
            
            <!-- Round instructions -->
            <div class="task-instructions" id="taskInstructions"></div>
            
            <!-- Mobile touch buttons -->
            <div class="mobile-buttons" id="mobileButtons">
                <button class="mobile-button left" id="buttonLeft">Left</button>
                <button class="mobile-button right" id="buttonRight">Right</button>
            </div>
        </div>

        <!-- ===== COMPLETION SCREEN ===== -->
        <div class="completion" id="completion">
            <h2>Thank You!</h2>
            <p>You have completed the study.</p>
            <p>Your response data has been saved.</p>
            
            <div id="analysisPreview" style="margin: 30px 0; max-height: 400px; overflow-y: auto; text-align: left;"></div>
            
            <div style="margin-top: 20px;">
                <button class="button" onclick="downloadData('json')" style="margin-right: 10px;">Download Raw Data (JSON)</button>
                <button class="button" onclick="downloadData('csv')" style="margin-right: 10px;">Download Raw Data (CSV)</button>
                <button class="button" onclick="downloadData('analysis')">Download Analysis (CSV)</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // CONFIGURATION & GLOBAL VARIABLES
        // =====================================================
        
        // Detect if user is on mobile device
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Set up initial instructions based on device type
        window.addEventListener('DOMContentLoaded', function() {
            if (isMobile) {
                document.getElementById('keyInstructions').classList.add('hidden');
                document.getElementById('buttonInstructions').classList.remove('hidden');
            }
        });
        
        // Brand names - CUSTOMIZE THESE for your study
        const brand1Name = 'Apple Music';
        const brand2Name = 'Spotify';
        
        // Trial state variables
        let currentRound = 0;              // Which round we're in (1, 2, or 3)
        let currentStimulus = null;        // Current image stimulus being shown
        let currentBrand = null;           // Current brand logo being shown
        let stimuli = [];                  // Array of image stimuli for current round
        let stimuli2 = [];                 // Array of brand stimuli for current round
        let allResponses = [];             // All collected response data
        let fix = 0;                       // Error correction flag (0 = correct, 1 = error)
        
        // Counterbalancing: Randomly assign which brand appears on which side
        // 0 = Brand 1 left, Brand 2 right
        // 1 = Brand 2 left, Brand 1 right
        const brandSideAssignment = Math.random() < 0.5 ? 0 : 1;
        const leftBrand = brandSideAssignment === 0 ? brand1Name : brand2Name;
        const rightBrand = brandSideAssignment === 0 ? brand2Name : brand1Name;

        // =====================================================
        // STIMULI DEFINITIONS
        // =====================================================
        
        // Image stimuli - only shown in Round 3 as primes
        // CUSTOMIZE THESE for your study - replace with your own image URLs
        const imageStimuli = [
            'https://raw.githubusercontent.com/JamesKelly17/implicit/refs/heads/main/Images/Spotify%20Logo.png',
            'https://raw.githubusercontent.com/JamesKelly17/implicit/refs/heads/main/Images/Apple%20Music%20Logo.png',
            'https://raw.githubusercontent.com/JamesKelly17/implicit/refs/heads/main/Images/Apple%20Logo.png',
            'https://raw.githubusercontent.com/JamesKelly17/implicit/refs/heads/main/Images/Green-Spotify.png',
            'https://raw.githubusercontent.com/JamesKelly17/implicit/refs/heads/main/Images/Red-Apple%20Music.png',
            'https://raw.githubusercontent.com/JamesKelly17/implicit/refs/heads/main/Images/YouTube%20Music%20Logo.png',
            'https://raw.githubusercontent.com/JamesKelly17/implicit/refs/heads/main/Images/Spotify_App.png',
            'https://raw.githubusercontent.com/JamesKelly17/implicit/refs/heads/main/Images/Apple_Music_App.png'
        ];
        
        // Labels for image stimuli - CUSTOMIZE THESE to match your images
        // These labels will appear in the analysis table and charts
        const imageStimuliLabels = [
            'Spotify Logo',
            'Apple Music Logo',
            'Apple Logo',
            'Spotify Green',
            'Apple Music Red',
            'YouTube Music Logo',
            'Spotify Full Branding',
            'Apple Music Full Branding'
        ];

        // =====================================================
        // NAVIGATION FUNCTIONS
        // =====================================================
        
        /**
         * Show the round structure instructions
         */
        function showRoundInstructions() {
            document.getElementById('initialInstructions').classList.add('hidden');
            document.getElementById('roundInstructions').classList.remove('hidden');
        }

        /**
         * Start the task - set up interface and load first round
         */
        function startTask() {
            document.getElementById('roundInstructions').classList.add('hidden');
            document.getElementById('taskContainer').style.display = 'block';
            
            // Update brand labels based on random assignment
            document.querySelector('.label-left').textContent = leftBrand;
            document.querySelector('.label-right').textContent = rightBrand;
            
            // Configure for mobile if needed
            if (isMobile) {
                document.getElementById('taskContainer').classList.add('mobile');
                document.getElementById('keyInstructions').classList.add('hidden');
                document.getElementById('buttonInstructions').classList.remove('hidden');
                document.querySelector('.label-left2').textContent = '(press "left")';
                document.querySelector('.label-right2').textContent = '(press "right")';
                document.getElementById('mobileButtons').classList.add('show');
            }
            
            loadRound(1);
        }

        // =====================================================
        // ROUND MANAGEMENT
        // =====================================================
        
        /**
         * Load and configure a specific round
         * @param {number} roundNum - Round number (1, 2, or 3)
         */
        function loadRound(roundNum) {
            currentRound = roundNum;
            document.getElementById('loadingMessage').style.display = 'none';
            
            // Hide fixation cross during instructions
            document.getElementById('messageCenter').style.display = 'none';
            
            const instructions = document.getElementById('taskInstructions');
            const titles = ['Practice Round', 'Round 1', 'Final Round'];
            const parts = ['Part 1 of 3', 'Part 2 of 3', 'Part 3 of 3'];
            
            // Different start instruction for mobile vs desktop
            const startInstruction = isMobile 
                ? "When you are ready, please <span style='font-weight: bold; color: #27ae60'>press either the Left or Right button to begin.</span>"
                : "When you are ready, please <span style='font-weight: bold; color: #27ae60'>press the [Space bar] to begin.</span>";
            
            // Build instruction text
            instructions.innerHTML = `
                <p><span style="font-weight: bold; font-size:26px;color: blue">${titles[roundNum - 1]}</span><br><br>
                ${roundNum === 1 ? "<span style='font-weight: bold'>Let's go through this one more time.</span>" : "<span style='font-weight: bold'>Same rules as before.</span>"}
                Place your ${isMobile ? 'fingers on the left and right buttons' : 'left and right index fingers on the E and I keys'}. 
                At the top of the screen are 2 brands. Once you get started, brand names will appear in the middle of the screen.<br><br>
                When the brand name matches the brand on the left, press the ${isMobile ? '<strong>left</strong> button' : '<strong>E</strong> key'} as fast as you can. 
                When it matches the brand on the right, press the ${isMobile ? '<strong>right</strong> button' : '<strong>I</strong> key'} as fast as you can. 
                If you make an error, a red <span style="font-weight: bold; color: red">X</span> will appear. 
                Correct errors by hitting the other ${isMobile ? 'button' : 'key'}. 
                Please try to go as <em>fast as you can</em> while making as few errors as possible. 
                If you are going too slow, a <span style="color: red">"Too Slow"</span> message will appear.<br><br>
                ${startInstruction}<br><br>
                ${parts[roundNum - 1]}</p>
            `;
            instructions.style.display = 'block';
            
            // Build stimuli arrays for this round
            buildStimuli(roundNum);
            
            // Set up input handlers
            if (!isMobile) {
                document.addEventListener('keyup', handleKeyPress);
            } else {
                document.getElementById('buttonLeft').onclick = () => simulateKey(69);
                document.getElementById('buttonRight').onclick = () => simulateKey(73);
            }
        }

        /**
         * Build stimulus arrays for a given round
         * @param {number} roundNum - Round number (1, 2, or 3)
         */
        function buildStimuli(roundNum) {
            stimuli = [];
            stimuli2 = [];
            
            // Number of trials per round
            // Round 1: 6 trials (practice)
            // Round 2: 12 trials (main task)
            // Round 3: 48 trials (priming - each image paired with each brand 3 times)
            const numTrials = roundNum === 1 ? 6 : (roundNum === 2 ? 12 : 48);
            
            // Determine correct key codes based on counterbalancing
            const brand1KeyCode = leftBrand === brand1Name ? 69 : 73;  // 69 = E key, 73 = I key
            const brand2KeyCode = leftBrand === brand2Name ? 69 : 73;
            
            if (roundNum === 3) {
                // Round 3: Create balanced image-brand pairs
                // Each image appears with each brand exactly 3 times
                const imageBrandPairs = [];
                
                for (let imgIdx = 0; imgIdx < imageStimuli.length; imgIdx++) {
                    const imageUrl = imageStimuli[imgIdx];
                    
                    // 3 repetitions with Brand 1
                    for (let rep = 0; rep < 3; rep++) {
                        imageBrandPairs.push({
                            imageUrl: imageUrl,
                            imageIndex: imgIdx + 1,
                            brand: brand1Name,
                            brandKeyCode: brand1KeyCode,
                            brandIndex: 15 + imgIdx * 3 + rep
                        });
                    }
                    
                    // 3 repetitions with Brand 2
                    for (let rep = 0; rep < 3; rep++) {
                        imageBrandPairs.push({
                            imageUrl: imageUrl,
                            imageIndex: imgIdx + 1,
                            brand: brand2Name,
                            brandKeyCode: brand2KeyCode,
                            brandIndex: 20 + imgIdx * 3 + rep
                        });
                    }
                }
                
                // Randomize the pairs
                shuffle(imageBrandPairs);
                
                // Build stimuli arrays from shuffled pairs
                imageBrandPairs.forEach(pair => {
                    // Image stimulus
                    const primeImg = new Image();
                    primeImg.src = pair.imageUrl;
                    primeImg.className = 'stimulus-image';
                    stimuli.push({
                        stimulus: primeImg,
                        correct: 0,
                        index: pair.imageIndex,
                        imageUrl: pair.imageUrl
                    });
                    
                    // Brand text stimulus
                    const brandDiv = document.createElement('div');
                    brandDiv.className = 'stimulus-text';
                    brandDiv.textContent = pair.brand;
                    stimuli2.push({
                        stimulus: brandDiv,
                        correct: pair.brandKeyCode,
                        index: pair.brandIndex,
                        brand: pair.brand
                    });
                });
            } else {
                // Rounds 1 & 2: Original random approach
                // Initialize empty arrays
                for (let i = 0; i < numTrials; i++) {
                    stimuli.push({ stimulus: '', correct: '', index: '' });
                    stimuli2.push({ stimulus: '', correct: '', index: '' });
                }
                
                // Build brand text stimuli (50/50 split between Brand 1 and Brand 2)
                const half = stimuli2.length / 2;
                
                // Brand 1 text
                for (let i = 0; i < half; i++) {
                    const brandDiv = document.createElement('div');
                    brandDiv.className = 'stimulus-text';
                    brandDiv.textContent = brand1Name;
                    stimuli2[i] = { 
                        stimulus: brandDiv, 
                        correct: brand1KeyCode, 
                        index: 15 + i, 
                        brand: brand1Name 
                    };
                }
                
                // Brand 2 text
                for (let i = half; i < stimuli2.length; i++) {
                    const brandDiv = document.createElement('div');
                    brandDiv.className = 'stimulus-text';
                    brandDiv.textContent = brand2Name;
                    stimuli2[i] = { 
                        stimulus: brandDiv, 
                        correct: brand2KeyCode, 
                        index: 20 + (i - half), 
                        brand: brand2Name 
                    };
                }
                
                // Randomize brand text order
                shuffle(stimuli2);
            }
        }

        /**
         * Shuffle array in place using Fisher-Yates algorithm
         * @param {Array} array - Array to shuffle
         */
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // =====================================================
        // INPUT HANDLING
        // =====================================================
        
        /**
         * Handle keyboard input (desktop version)
         * @param {KeyboardEvent} e - Keyboard event
         */
        function handleKeyPress(e) {
            const keyCode = e.keyCode;
            
            // Spacebar starts the round if not already started
            if (!currentStimulus && keyCode === 32) {
                startRound();
                return;
            }
            
            // Only process E (69) or I (73) keys during trials
            if (!(keyCode === 69 || keyCode === 73)) return;
            
            processResponse(keyCode);
        }

        /**
         * Simulate key press for mobile buttons
         * @param {number} keyCode - Key code to simulate (69 for E, 73 for I)
         */
        function simulateKey(keyCode) {
            if (!currentStimulus) {
                startRound();
                return;
            }
            processResponse(keyCode);
        }

        // =====================================================
        // TRIAL MANAGEMENT
        // =====================================================
        
        /**
         * Start the current round (hide instructions, show first trial)
         */
        function startRound() {
            document.getElementById('taskInstructions').style.display = 'none';
            
            // Show message center for fixation cross and stimuli
            document.getElementById('messageCenter').style.display = 'flex';
            document.getElementById('messageCenter').innerHTML = '+';
            
            // Brief delay before first trial
            setTimeout(nextQuestion, 500);
        }

        /**
         * Present the next trial (image prime + brand name)
         */
        function nextQuestion() {
            // Check if round is complete
            if (stimuli2.length === 0) {
                endRound();
                return;
            }
            
            // Get next stimuli (pop removes from end of array)
            currentStimulus = stimuli.pop();
            currentBrand = stimuli2.pop();
            
            // Clear display
            document.getElementById('messageCenter').innerHTML = '';
            document.getElementById('errorMessage').textContent = '';
            
            // Record trial start time
            currentBrand.start = Date.now();
            
            const messageEl = document.getElementById('messageCenter');
            
            // Round 3: Show image prime first, then brand name
            if (currentRound === 3 && currentStimulus && currentStimulus.stimulus) {
                // Display image prime
                messageEl.appendChild(currentStimulus.stimulus);
                
                // Clear after 200ms
                setTimeout(() => {
                    messageEl.innerHTML = '';
                }, 200);
                
                // Show brand name after 300ms
                setTimeout(() => {
                    messageEl.innerHTML = '';
                    messageEl.appendChild(currentBrand.stimulus);
                }, 300);
            } else {
                // Rounds 1 & 2: Just show brand name
                messageEl.appendChild(currentBrand.stimulus);
            }
        }

        /**
         * Process user's response to current trial
         * @param {number} keyCode - Key code pressed (69 = E/left, 73 = I/right)
         */
        function processResponse(keyCode) {
            // Check if response is correct
            if (keyCode === currentBrand.correct) {
                // Record timing
                currentBrand.end = Date.now();
                currentBrand.reactionTime = currentBrand.end - currentBrand.start;
                
                // Extract response information
                const brandName = currentBrand.brand;
                const brandSide = keyCode === 69 ? 'left' : 'right';
                
                // Extract image prime info (only for Round 3)
                let imageUrl = 'None';
                let imageIndex = 0;
                
                if (currentRound === 3 && currentStimulus && currentStimulus.stimulus) {
                    imageUrl = currentStimulus.imageUrl || 'None';
                    imageIndex = currentStimulus.index;
                }
                
                // Create response data object
                const responseData = {
                    round: currentRound,
                    correct: fix === 0 ? 'C' : 'X',  // C = correct first try, X = corrected error
                    reactionTime: currentBrand.reactionTime,
                    brandIndex: currentBrand.index,
                    brandName: brandName,
                    brandSide: brandSide,
                    imageIndex: imageIndex,
                    imageUrl: imageUrl,
                    counterbalanceCondition: brandSideAssignment,
                    appleMusicSide: leftBrand === 'Apple Music' ? 'left' : 'right',
                    spotifySide: leftBrand === 'Spotify' ? 'left' : 'right'
                };
                
                // Save response
                allResponses.push(responseData);
                
                // Provide feedback based on reaction time
                if (currentBrand.reactionTime < 1250) {
                    // Fast enough - show fixation cross
                    document.getElementById('messageCenter').innerHTML = '+';
                    fix = 0;
                    currentStimulus = null;
                    document.getElementById('errorMessage').textContent = '';
                    setTimeout(nextQuestion, 400);
                } else {
                    // Too slow warning
                    document.getElementById('messageCenter').innerHTML = '<div style="color:red;font-size:30px">Too Slow</div>';
                    fix = 0;
                    currentStimulus = null;
                    document.getElementById('errorMessage').textContent = '';
                    setTimeout(nextQuestion, 400);
                }
            } else {
                // Incorrect response - show error and require correction
                document.getElementById('errorMessage').textContent = 'X';
                fix = 1;  // Flag that error correction is needed
            }
        }

        /**
         * End current round and proceed to next or complete task
         */
        function endRound() {
            if (currentRound < 3) {
                // Show brief fixation before next round
                document.getElementById('messageCenter').innerHTML = '+';
                setTimeout(() => {
                    loadRound(currentRound + 1);
                }, 1000);
            } else {
                // All rounds complete
                completeTask();
            }
        }

        // =====================================================
        // COMPLETION & DATA EXPORT
        // =====================================================
        
        /**
         * Complete the task and show thank you screen
         */
        function completeTask() {
            document.getElementById('taskContainer').style.display = 'none';
            document.getElementById('completion').style.display = 'block';
            
            // Save to browser storage as backup
            localStorage.setItem('iat_responses', JSON.stringify(allResponses));
            
            // Calculate analysis
            calculatePrimingAnalysis();
        }
        
        /**
         * Calculate priming effect analysis
         * Compares Round 3 (with primes) to Round 2 (baseline)
         */
        let primingAnalysis = [];
        
        function calculatePrimingAnalysis() {
            // Filter out outliers (top 98.5 percentile and bottom 1.5 percentile, |z-score| > 2.167) from rounds 2 and 3
            const filterOutliers = (data) => {
                if (data.length === 0) return data;
                
                // Calculate mean and standard deviation
                const reactionTimes = data.map(r => r.reactionTime);
                const mean = reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length;
                const variance = reactionTimes.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / reactionTimes.length;
                const stdDev = Math.sqrt(variance);
                
                // Filter out responses with |z-score| > 2.167 (both extremes)
                return data.filter(r => {
                    const zScore = (r.reactionTime - mean) / stdDev;
                    return zScore >= -1.96 && zScore <= 1.96;
                });
            };
            
            // Get Round 2 data (correct only) and filter outliers
            let round2Data = allResponses.filter(r => r.round === 2 && r.correct === 'C');
            round2Data = filterOutliers(round2Data);
            
            const round2ByBrand = {};
            
            round2Data.forEach(r => {
                if (!round2ByBrand[r.brandName]) {
                    round2ByBrand[r.brandName] = [];
                }
                round2ByBrand[r.brandName].push(r.reactionTime);
            });
            
            const round2Averages = {};
            for (const brand in round2ByBrand) {
                const times = round2ByBrand[brand];
                round2Averages[brand] = times.reduce((a, b) => a + b, 0) / times.length;
            }
            
            // Get Round 3 data (all responses) and filter outliers
            let round3Data = allResponses.filter(r => r.round === 3);
            round3Data = filterOutliers(round3Data);
            
            const round3ByBrandImage = {};
            
            round3Data.forEach(r => {
                const key = `${r.brandName}|${r.imageUrl}`;
                if (!round3ByBrandImage[key]) {
                    round3ByBrandImage[key] = [];
                }
                round3ByBrandImage[key].push(r.reactionTime);
            });
            
            // Calculate differences
            primingAnalysis = [];
            const allDifferences = [];
            
            for (const key in round3ByBrandImage) {
                const [brand, imageUrl] = key.split('|');
                const times = round3ByBrandImage[key];
                const round3Avg = times.reduce((a, b) => a + b, 0) / times.length;
                const round2Avg = round2Averages[brand] || 0;
                const difference = round3Avg - round2Avg;
                
                // Get label for this image
                const imageIndex = imageStimuli.indexOf(imageUrl);
                const imageLabel = imageIndex >= 0 ? imageStimuliLabels[imageIndex] : 'Unknown';
                
                primingAnalysis.push({
                    brandName: brand,
                    imageUrl: imageUrl,
                    imageLabel: imageLabel,
                    round3_avgRT: Math.round(round3Avg),
                    round2_avgRT: Math.round(round2Avg),
                    difference: Math.round(difference),
                    trialCount: times.length
                });
                
                allDifferences.push(difference);
            }
            
            // Calculate mean and standard deviation for standardization
            const mean = allDifferences.reduce((a, b) => a + b, 0) / allDifferences.length;
            const variance = allDifferences.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / allDifferences.length;
            const stdDev = Math.sqrt(variance);
            
            // Add standardized score (z-score * -1)
            primingAnalysis.forEach(item => {
                const zScore = (item.difference - mean) / stdDev;
                item.score = parseFloat((zScore * -1).toFixed(3));
            });
            
            // Calculate average score per image for sorting
            const imageScores = {};
            primingAnalysis.forEach(item => {
                if (!imageScores[item.imageLabel]) {
                    imageScores[item.imageLabel] = [];
                }
                imageScores[item.imageLabel].push(item.score);
            });
            
            const imageAvgScores = {};
            for (const imageLabel in imageScores) {
                imageAvgScores[imageLabel] = imageScores[imageLabel].reduce((a, b) => a + b, 0) / imageScores[imageLabel].length;
            }
            
            // Sort by average score (largest to smallest), then by brand
            primingAnalysis.sort((a, b) => {
                const avgA = imageAvgScores[a.imageLabel];
                const avgB = imageAvgScores[b.imageLabel];
                if (avgA !== avgB) {
                    return avgB - avgA; // Descending order
                }
                return a.brandName.localeCompare(b.brandName);
            });
            
            // Display preview
            displayAnalysisPreview();
        }
        
        /**
         * Display analysis preview on completion screen
         */
        function displayAnalysisPreview() {
            const previewEl = document.getElementById('analysisPreview');
            
            let html = '<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">';
            html += '<strong style="color: #856404;">⚠️ Disclaimer:</strong> ';
            html += '<span style="color: #856404;">These scores are for demonstration purposes only. Results cannot be reported on an individual level. A sample size of n≥120 is required for significant findings.</span>';
            html += '</div>';
            
            html += '<h3 style="color: #333; margin-bottom: 15px;">Priming Based Implicit Analysis</h3>';
            html += '<p style="font-size: 14px; margin-bottom: 15px;">Standardized scores showing brand-image associations. Higher scores indicate stronger associations (faster responses).</p>';
            
            // Create chart first
            html += createScoreChart();
            
            // Sort data by score for table display (largest to smallest)
            const tableSortedData = [...primingAnalysis].sort((a, b) => b.score - a.score);
            
            // Table below chart
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 30px;">';
            html += '<thead><tr style="background: #f0f0f0; border-bottom: 2px solid #ddd;">';
            html += '<th style="padding: 8px; text-align: left;">Brand</th>';
            html += '<th style="padding: 8px; text-align: left;">Brand Associations</th>';
            html += '<th style="padding: 8px; text-align: right;">Round 3 RT</th>';
            html += '<th style="padding: 8px; text-align: right;">Round 2 RT</th>';
            html += '<th style="padding: 8px; text-align: right;">Difference</th>';
            html += '<th style="padding: 8px; text-align: right;">Score</th>';
            html += '</tr></thead><tbody>';
            
            tableSortedData.forEach((row) => {
                const scoreColor = row.score > 0 ? '#27ae60' : '#e74c3c';
                html += '<tr style="border-bottom: 1px solid #eee;">';
                html += `<td style="padding: 8px;">${row.brandName}</td>`;
                html += `<td style="padding: 8px;"><strong>${row.imageLabel}</strong></td>`;
                html += `<td style="padding: 8px; text-align: right;">${row.round3_avgRT}ms</td>`;
                html += `<td style="padding: 8px; text-align: right;">${row.round2_avgRT}ms</td>`;
                html += `<td style="padding: 8px; text-align: right;">${row.difference > 0 ? '+' : ''}${row.difference}ms</td>`;
                html += `<td style="padding: 8px; text-align: right; color: ${scoreColor}; font-weight: bold;">${row.score}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            previewEl.innerHTML = html;
        }
        
        /**
         * Create two separate bar charts of scores, one for each brand
         */
        function createScoreChart() {
            // Organize data by brand
            const brandData = {};
            primingAnalysis.forEach(item => {
                if (!brandData[item.brandName]) {
                    brandData[item.brandName] = [];
                }
                
                brandData[item.brandName].push({
                    label: item.imageLabel,
                    imageUrl: item.imageUrl,
                    score: item.score
                });
            });
            
            // Sort each brand's data by score (descending)
            const brands = Object.keys(brandData).sort();
            brands.forEach(brand => {
                brandData[brand].sort((a, b) => b.score - a.score);
            });
            
            // Brand colors
            const brandColors = {
                'Apple Music': '#FA243C',
                'Spotify': '#1DB954'
            };
            
            // Calculate GLOBAL scale across all brands for comparison
            const allScores = primingAnalysis.map(item => item.score);
            const globalMinScore = Math.min(...allScores, 0);
            const globalMaxScore = Math.max(...allScores, 0);
            const globalScoreRange = globalMaxScore - globalMinScore;
            
            // Chart dimensions
            const chartWidth = 350;
            const chartHeight = 450;
            const margin = { top: 40, right: 20, bottom: 120, left: 60 };
            const plotWidth = chartWidth - margin.left - margin.right;
            const plotHeight = chartHeight - margin.top - margin.bottom;
            
            let html = '<div style="margin-top: 20px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">';
            
            // Create a chart for each brand
            brands.forEach(brand => {
                const data = brandData[brand];
                const color = brandColors[brand] || '#888';
                
                // Bar dimensions
                const barWidth = plotWidth / data.length * 0.8;
                const barSpacing = plotWidth / data.length * 0.1;
                
                html += '<div style="text-align: center;">';
                html += `<h4 style="color: ${color}; margin-bottom: 10px; font-size: 16px;">${brand}</h4>`;
                html += `<svg width="${chartWidth}" height="${chartHeight}" style="border: 1px solid #ddd; background: white;">`;
                
                // Y-axis scale function using GLOBAL range
                const yScale = (score) => margin.top + plotHeight - ((score - globalMinScore) / globalScoreRange) * plotHeight;
                
                // Draw horizontal grid lines
                for (let i = 0; i <= 5; i++) {
                    const score = globalMinScore + (globalScoreRange * i / 5);
                    const y = yScale(score);
                    html += `<line x1="${margin.left}" y1="${y}" x2="${chartWidth - margin.right}" y2="${y}" stroke="#e0e0e0" stroke-width="1"/>`;
                    html += `<text x="${margin.left - 10}" y="${y + 4}" text-anchor="end" font-size="11" fill="#666">${score.toFixed(1)}</text>`;
                }
                
                // Draw zero line
                if (globalMinScore < 0 && globalMaxScore > 0) {
                    const zeroY = yScale(0);
                    html += `<line x1="${margin.left}" y1="${zeroY}" x2="${chartWidth - margin.right}" y2="${zeroY}" stroke="#333" stroke-width="2"/>`;
                }
                
                // Draw bars
                data.forEach((item, idx) => {
                    const barX = margin.left + idx * (barWidth + barSpacing * 2) + barSpacing;
                    const score = item.score;
                    const barHeight = Math.abs((score - 0) / globalScoreRange) * plotHeight;
                    const barY = score >= 0 ? yScale(score) : yScale(0);
                    
                    html += `<rect x="${barX}" y="${barY}" width="${barWidth}" height="${barHeight}" fill="${color}" opacity="0.8"/>`;
                    
                    // Add score label on top of bar
                    const labelY = score >= 0 ? barY - 5 : barY + barHeight + 12;
                    html += `<text x="${barX + barWidth/2}" y="${labelY}" text-anchor="middle" font-size="10" fill="#333" font-weight="bold">${score.toFixed(2)}</text>`;
                    
                    // X-axis label (image label)
                    const labelX = barX + barWidth/2;
                    html += `<text x="${labelX}" y="${chartHeight - margin.bottom + 20}" text-anchor="end" font-size="11" fill="#333" transform="rotate(-45 ${labelX} ${chartHeight - margin.bottom + 20})">${item.label}</text>`;
                });
                
                // Y-axis label
                html += `<text x="${20}" y="${chartHeight/2}" text-anchor="middle" font-size="13" font-weight="bold" fill="#333" transform="rotate(-90 20 ${chartHeight/2})">Score</text>`;
                
                html += '</svg></div>';
            });
            
            html += '</div>';
            
            return html;
        }

        /**
         * Download collected data as JSON or CSV
         * @param {string} format - 'json', 'csv', or 'analysis'
         */
        function downloadData(format = 'json') {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            let dataStr, dataBlob, filename;
            
            if (format === 'analysis') {
                dataStr = convertToCSV(primingAnalysis);
                dataBlob = new Blob([dataStr], { type: 'text/csv' });
                filename = `priming_analysis_${timestamp}.csv`;
            } else if (format === 'csv') {
                dataStr = convertToCSV(allResponses);
                dataBlob = new Blob([dataStr], { type: 'text/csv' });
                filename = `survey_results_${timestamp}.csv`;
            } else {
                dataStr = JSON.stringify(allResponses, null, 2);
                dataBlob = new Blob([dataStr], { type: 'application/json' });
                filename = `survey_results_${timestamp}.json`;
            }
            
            // Trigger download
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        /**
         * Convert response data array to CSV format
         * @param {Array} data - Array of response objects
         * @returns {string} CSV formatted string
         */
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            // Extract headers from first object
            const headers = Object.keys(data[0]);
            
            // Build CSV string
            let csv = headers.join(',') + '\n';
            
            // Add data rows
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    // Wrap values containing commas in quotes
                    if (typeof value === 'string' && value.includes(',')) {
                        return `"${value}"`;
                    }
                    return value;
                });
                csv += values.join(',') + '\n';
            });
            
            return csv;
        }
    </script>
</body>
</html>